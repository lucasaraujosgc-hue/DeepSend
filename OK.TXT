FROM node:22-alpine

# Instala dependências do sistema necessárias
# git: Necessário para instalar 'whatsapp-web.js' direto do GitHub
# chromium e bibliotecas gráficas: Necessários para o Puppeteer funcionar no ambiente Alpine
RUN apk add --no-cache \
    git \
    chromium \
    nss \
    freetype \
    harfbuzz \
    ca-certificates \
    ttf-freefont \
    nodejs \
    yarn

# Configura o Puppeteer para usar o Chromium instalado no sistema (Alpine)
# Isso evita o download do Chromium duplicado e incompatibilidades
ENV PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true \
    PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser

# Define o diretório de trabalho
WORKDIR /app

# Copia os arquivos de definição de dependências primeiro (cache layer)
COPY package*.json ./

# Instala as dependências do projeto
# O git instalado acima permite baixar o whatsapp-web.js do GitHub
RUN npm install

# Copia o restante do código fonte
COPY . .

# Executa o build do frontend (Vite)
RUN npm run build

# Cria diretórios para persistência de dados (SQLite e Uploads)
# Importante mapear volumes no Easypanel para /app/data
RUN mkdir -p /app/data/uploads

# Expõe a porta que o servidor Express usa
EXPOSE 3000

# Comando de inicialização
CMD ["npm", "start"]
